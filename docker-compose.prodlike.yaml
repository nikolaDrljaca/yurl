# PRODLIKE docker compose script

services:
  yurl-service:
    image: yurl:2025.1
    build: .
    container_name: yurl-service
    ports:
      - "5000:5000"
    volumes:
      # Mount SQLite file into container at /data/db.sqlite
      - "./app-data:/data"
    environment:
      DB_URL: "jdbc:sqlite:/data/yurl-db.sqlite"
      # NOTE: No longer used, comment left as example
      #API_KEY: "ed5b50b4-a8ef-43d6-8622-9f67f35700e5"
      VALKEY_HOST: "yurl-cache"
      VALKEY_PORT: "6379"
      BASE_PATH: "http://localhost:5000"

    # hardening
    security_opt:
      - "no-new-privileges=true"
    restart: on-failure:5
    cpus: '0.5'
    mem_limit: 512m

    # orchestration
    depends_on:
      hop-cache:
          condition: service_healthy

  hop-cache:
    image: "valkey/valkey:8-alpine"
    container_name: yurl-cache
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 20s
      retries: 3
    command: |
      valkey-server --save "" 
          --appendonly no
          --maxmemory 256mb 
          --maxmemory-policy allkeys-lru

